name: Update TVLive M3U

on:
  schedule:
    - cron: '0 */4 * * *'  # 每4小时运行一次
  workflow_dispatch:  # 手动触发

jobs:
  update-m3u:
    runs-on: ubuntu-22.04  # 显式指定兼容的环境

    steps:
    # 检出代码
    - name: Checkout repository
      uses: actions/checkout@v3

    # 下载并修改 m3u 文件
    - name: Download and process M3U file
      run: |
        # 创建目录
        mkdir -p m3u_files
        
        # 下载 ipv6.m3u 文件
        curl -sL -o m3u_files/ipv6.m3u https://raw.githubusercontent.com/suxuang/myIPTV/refs/heads/main/ipv6.m3u
        
        # 处理文件逻辑
        awk '
        BEGIN { skip=0 } 
        /^#.*频道/ { skip=1 } 
        skip==0 { buffer[NR]=$0 } 
        skip==1 && /(?:[a-fA-F0-9]{1,4}:){2,7}[a-fA-F0-9]{1,4}/ { 
            print buffer[NR-1]
            print $0 
        }' m3u_files/ipv6.m3u > cnlive.m3u
        
        echo "Filtered and saved as cnlive.m3u."
        
    # 提交并推送更改
    - name: Commit and push changes
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git add cnlive.m3u
        git commit -m "Update cnlive.m3u on $(date)" || echo "No changes to commit"
        git push origin main
